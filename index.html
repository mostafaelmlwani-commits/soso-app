<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soso Studio Review</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #ffffff;
            --accent-color: #3390ec;
            --danger-color: #ff4d4d;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
        }
        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-top: 10px;
            background: #000;
        }
        video { 
            width: 100%; 
            display: block; 
            border-radius: 8px;
        }
        canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .controls-area {
            width: 90%; max-width: 800px; margin-top: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .main-btn {
            background-color: var(--accent-color); color: white;
            border: none; padding: 12px 20px; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            flex-grow: 1; margin: 0 5px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .drawing-tools {
            display: none;
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px; border-radius: 8px;
            z-index: 20;
            flex-direction: column; gap: 10px;
        }
        .color-btn {
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; cursor: pointer;
        }
        .feedback-list {
            width: 95%; max-width: 800px; margin-top: 20px; margin-bottom: 50px;
        }
        .feedback-item {
            background: #2d2d2d; border-radius: 8px; padding: 10px;
            margin-bottom: 10px; display: flex; gap: 10px; align-items: start;
            border-right: 4px solid var(--accent-color);
        }
        .feedback-thumb {
            width: 80px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #555;
        }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #2d2d2d; padding: 20px; border-radius: 12px; width: 85%; max-width: 400px; text-align: center;
        }
        textarea {
            width: 100%; height: 80px; margin: 10px 0; padding: 8px;
            border-radius: 6px; border: none; background: #444; color: white;
        }
    </style>
</head>
<body>

    <div class="video-wrapper" id="videoWrapper">
        <video id="videoPlayer" controls playsinline webkit-playsinline>
            <source src="" type="video/mp4">
        </video>
        <canvas id="drawingCanvas"></canvas>
        
        <div class="drawing-tools" id="drawingTools">
            <div class="color-btn" style="background: #ff4d4d;" onclick="setColor('#ff4d4d', this)"></div>
            <div class="color-btn" style="background: #4dff4d;" onclick="setColor('#4dff4d', this)"></div>
            <div class="color-btn" style="background: #ffff4d;" onclick="setColor('#ffff4d', this)"></div>
            <div class="color-btn" style="background: white; display: flex; align-items: center; justify-content: center;" onclick="clearCanvas()">
                <i class="fas fa-trash-alt" style="color: black; font-size: 14px;"></i>
            </div>
        </div>
    </div>

    <div class="controls-area">
        <button class="main-btn" id="addNoteBtn" onclick="startEditing()">
            <i class="fas fa-pen"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©
        </button>
        <button class="main-btn" id="finishBtn" onclick="submitAll()" style="background-color: #28a745; display: none;">
            <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (<span id="count">0</span>)
        </button>
    </div>

    <div class="modal" id="noteModal">
        <div class="modal-content">
            <h3>ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</h3>
            <textarea id="noteInput" placeholder="Ø§ÙƒØªØ¨ Ù…Ø´ÙƒÙ„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            <div style="display: flex; gap: 10px;">
                <button class="main-btn" onclick="saveFeedback()" style="background: var(--accent-color);">Ø­ÙØ¸</button>
                <button class="main-btn" onclick="cancelEditing()" style="background: #555;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="feedback-list" id="feedbackList"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');
    const videoUrl = urlParams.get('video');
    
    const video = document.getElementById('videoPlayer');
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('videoWrapper');
    
    let isEditing = false;
    let feedbackArray = [];
    let currentColor = '#ff4d4d';

    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£ØµÙ„ Ø§Ù„Ø¨Ø³ÙŠØ· Ø¹Ø´Ø§Ù† ÙŠØ´ØªØºÙ„)
    if (videoUrl) {
        // Ø´ÙŠÙ„Ù†Ø§ Ø§Ù„Ù€ crossOrigin Ø®Ø§Ù„Øµ Ø¹Ø´Ø§Ù† Ù‡ÙŠ Ø§Ù„Ù„ÙŠ ÙƒØ§Ù†Øª Ø¨ØªØ³ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©
        video.src = decodeURIComponent(videoUrl);
        video.load();
    } else {
        alert("âŒ Ø®Ø·Ø£: Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯!");
    }

    // 2. Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
    function resizeCanvas() {
        canvas.width = video.clientWidth;
        canvas.height = video.clientHeight;
    }
    video.addEventListener('loadedmetadata', resizeCanvas);
    window.addEventListener('resize', resizeCanvas);

    // 3. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    function startEditing() {
        isEditing = true;
        video.pause();
        video.controls = false;
        
        resizeCanvas();
        canvas.style.pointerEvents = 'auto';
        
        document.getElementById('drawingTools').style.display = 'flex';
        document.getElementById('addNoteBtn').style.display = 'none';
        
        const saveBtn = document.createElement('button');
        saveBtn.id = 'tempSaveBtn';
        saveBtn.className = 'main-btn';
        saveBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø±Ø³Ù…';
        saveBtn.style.background = '#e0a800';
        saveBtn.onclick = () => document.getElementById('noteModal').style.display = 'flex';
        document.querySelector('.controls-area').appendChild(saveBtn);
    }

    // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… (Ø¨Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªØ¸Ø¨Ø· Ø§Ù„Ù…ÙƒØ§Ù†)
    let painting = false;

    function getScale() {
        const rect = canvas.getBoundingClientRect();
        return {
            x: canvas.width / rect.width,
            y: canvas.height / rect.height
        };
    }

    function startPosition(e) {
        painting = true;
        draw(e);
    }

    function endPosition() {
        painting = false;
        ctx.beginPath();
    }

    function draw(e) {
        if (!painting) return;
        if(e.type.includes('touch')) e.preventDefault();

        const rect = canvas.getBoundingClientRect();
        const scale = getScale();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        const x = (clientX - rect.left) * scale.x;
        const y = (clientY - rect.top) * scale.y;

        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.strokeStyle = currentColor;

        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    canvas.addEventListener('mousedown', startPosition);
    canvas.addEventListener('mouseup', endPosition);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchstart', startPosition, {passive: false});
    canvas.addEventListener('touchend', endPosition);
    canvas.addEventListener('touchmove', draw, {passive: false});

    // 5. Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù„ÙŠ Ù…Ø´ Ø¨ØªÙ‡Ù†Ø¬)
    function saveFeedback() {
        const note = document.getElementById('noteInput').value;
        const timestamp = formatTime(video.currentTime);
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Ù‡Ù†Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ù…Ø© Ø¨Ø³ Ø¹Ù„Ù‰ Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ Ø¹Ø´Ø§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…ÙŠØ³ÙˆØ¯Ø´
        tempCtx.fillStyle = "black";
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        tempCtx.drawImage(canvas, 0, 0);
        
        const imageData = tempCanvas.toDataURL('image/jpeg', 0.6);

        feedbackArray.push({
            time: timestamp,
            rawTime: video.currentTime,
            note: note,
            image: imageData
        });

        updateFeedbackList();
        cancelEditing();
    }

    function cancelEditing() {
        isEditing = false;
        canvas.style.pointerEvents = 'none';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        document.getElementById('drawingTools').style.display = 'none';
        document.getElementById('addNoteBtn').style.display = 'flex';
        document.getElementById('noteModal').style.display = 'none';
        document.getElementById('noteInput').value = '';

        const tempBtn = document.getElementById('tempSaveBtn');
        if(tempBtn) tempBtn.remove();
        
        video.controls = true; 
        video.play();
    }

    function updateFeedbackList() {
        const list = document.getElementById('feedbackList');
        list.innerHTML = '';
        feedbackArray.forEach((item, index) => {
            list.innerHTML += `
                <div class="feedback-item">
                    <img src="${item.image}" class="feedback-thumb" onclick="jumpTo(${item.rawTime})">
                    <div class="feedback-content">
                        <span class="feedback-time">${item.time}</span>
                        <p class="feedback-note">${item.note}</p>
                    </div>
                    <button class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-trash"></i></button>
                </div>
            `;
        });
        const finishBtn = document.getElementById('finishBtn');
        if (feedbackArray.length > 0) {
            finishBtn.style.display = 'flex';
            document.getElementById('count').innerText = feedbackArray.length;
        } else {
            finishBtn.style.display = 'none';
        }
    }

    function deleteItem(index) {
        feedbackArray.splice(index, 1);
        updateFeedbackList();
    }

    function jumpTo(time) {
        video.currentTime = time;
        video.pause();
    }

    async function submitAll() {
        const btn = document.getElementById('finishBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        btn.disabled = true;

        const payload = { projectId: projectId, feedbacks: feedbackArray };

        try {
            const response = await fetch('https://files.royamedia.com/api/submit-review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                tg.showPopup({ title: 'ØªÙ…!', message: 'ÙˆØµÙ„Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ ğŸš€', buttons: [{type: "ok"}] });
                tg.close();
            } else { throw new Error(); }
        } catch (e) {
            tg.sendData(JSON.stringify({ 
                action: "VIDEO_FEEDBACK_V2", 
                projectId: projectId, 
                count: feedbackArray.length,
                summary: feedbackArray.map(f => `â° ${f.time}: ${f.note}`).join('\n') 
            }));
        }
        btn.disabled = false;
        btn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
    }

    function setColor(color, btn) {
        currentColor = color;
        document.querySelectorAll('.color-btn').forEach(b => b.style.transform = 'scale(1)');
        btn.style.transform = 'scale(1.2)';
    }
    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }
</script>
</body>
</html>
