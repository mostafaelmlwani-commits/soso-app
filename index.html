<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soso Studio Review</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #ffffff;
            --accent-color: #3390ec;
            --danger-color: #ff4d4d;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø±Ø³Ø§Ù… */
        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-top: 10px;
        }
        video { 
            width: 100%; 
            display: block; 
            border-radius: 8px;
        }
        canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù„Ù…Ø³ ÙŠØ¹Ø¯ÙŠ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© */
            z-index: 10;
        }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… */
        .controls-area {
            width: 90%; max-width: 800px; margin-top: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .main-btn {
            background-color: var(--accent-color); color: white;
            border: none; padding: 12px 20px; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            flex-grow: 1; margin: 0 5px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) */
        .drawing-tools {
            display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px; border-radius: 8px;
            z-index: 20;
            flex-direction: column; gap: 10px;
        }
        .color-btn {
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; cursor: pointer;
        }
        .active-tool { border-color: yellow; transform: scale(1.1); }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© */
        .feedback-list {
            width: 95%; max-width: 800px; margin-top: 20px; margin-bottom: 50px;
        }
        .feedback-item {
            background: #2d2d2d; border-radius: 8px; padding: 10px;
            margin-bottom: 10px; display: flex; gap: 10px; align-items: start;
            border-right: 4px solid var(--accent-color);
        }
        .feedback-thumb {
            width: 80px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #555;
        }
        .feedback-content { flex-grow: 1; }
        .feedback-time { font-size: 12px; color: #aaa; background: #000; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .feedback-note { font-size: 14px; margin: 0; }
        .delete-btn { color: var(--danger-color); background: none; border: none; cursor: pointer; }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #2d2d2d; padding: 20px; border-radius: 12px; width: 85%; max-width: 400px; text-align: center;
        }
        textarea {
            width: 100%; height: 80px; margin: 10px 0; padding: 8px;
            border-radius: 6px; border: none; background: #444; color: white;
        }
    </style>
</head>
<body>

    <div class="video-wrapper" id="videoWrapper">
        <video id="videoPlayer" controls playsinline webkit-playsinline crossorigin="anonymous">
            <source src="" type="video/mp4">
        </video>
        <canvas id="drawingCanvas"></canvas>
        
        <div class="drawing-tools" id="drawingTools">
            <div class="color-btn" style="background: #ff4d4d;" onclick="setColor('#ff4d4d', this)" class="active-tool"></div> <div class="color-btn" style="background: #4dff4d;" onclick="setColor('#4dff4d', this)"></div> <div class="color-btn" style="background: #ffff4d;" onclick="setColor('#ffff4d', this)"></div> <div class="color-btn" style="background: white; display: flex; align-items: center; justify-content: center;" onclick="clearCanvas()">
                <i class="fas fa-trash-alt" style="color: black; font-size: 14px;"></i>
            </div>
        </div>
    </div>

    <div class="controls-area">
        <button class="main-btn" id="addNoteBtn" onclick="startEditing()">
            <i class="fas fa-pen"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©
        </button>
        <button class="main-btn" id="finishBtn" onclick="submitAll()" style="background-color: #28a745; display: none;">
            <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (<span id="count">0</span>)
        </button>
    </div>

    <div class="modal" id="noteModal">
        <div class="modal-content">
            <h3>ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</h3>
            <textarea id="noteInput" placeholder="Ø§ÙƒØªØ¨ Ù…Ø´ÙƒÙ„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            <div style="display: flex; gap: 10px;">
                <button class="main-btn" onclick="saveFeedback()" style="background: var(--accent-color);">Ø­ÙØ¸</button>
                <button class="main-btn" onclick="cancelEditing()" style="background: #555;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="feedback-list" id="feedbackList">
        </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');
    const videoUrl = urlParams.get('video');
    
    const video = document.getElementById('videoPlayer');
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('videoWrapper');
    
    let isEditing = false;
    let feedbackArray = [];
    let currentColor = '#ff4d4d';

    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    if (videoUrl) {
        video.src = decodeURIComponent(videoUrl);
        video.load();
    } else {
        alert("âŒ Ø®Ø·Ø£: Ù…ÙÙŠØ´ ÙÙŠØ¯ÙŠÙˆ!");
    }

    // 2. Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    function resizeCanvas() {
        canvas.width = video.videoWidth || wrapper.clientWidth;
        canvas.height = video.videoHeight || wrapper.clientHeight;
        // Ø¶Ø¨Ø· Ø§Ù„Ù€ Scale Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø³Ù… ÙŠÙƒÙˆÙ† Ø¯Ù‚ÙŠÙ‚
        const displayWidth = wrapper.clientWidth;
        const displayHeight = wrapper.clientHeight;
        if (canvas.width !== displayWidth || canvas.height !== displayHeight) {
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
        }
    }
    video.addEventListener('loadedmetadata', resizeCanvas);
    window.addEventListener('resize', resizeCanvas);

    // 3. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…)
    function startEditing() {
        isEditing = true;
        video.pause();
        video.controls = false; // ğŸ‘ˆ Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù‡Ù†Ø§ (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­ÙƒÙ…)
        
        // ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
        canvas.width = video.clientWidth; // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
        canvas.height = video.clientHeight;
        canvas.style.pointerEvents = 'auto'; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ù…Ø³
        
        document.getElementById('drawingTools').style.display = 'flex';
        document.getElementById('addNoteBtn').style.display = 'none';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙÙˆØ±ÙŠ
        const saveBtn = document.createElement('button');
        saveBtn.id = 'tempSaveBtn';
        saveBtn.className = 'main-btn';
        saveBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø±Ø³Ù…';
        saveBtn.style.background = '#e0a800';
        saveBtn.onclick = () => document.getElementById('noteModal').style.display = 'flex';
        document.querySelector('.controls-area').appendChild(saveBtn);
    }

    // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… (ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„Ù…Ø§ÙˆØ³)
    let painting = false;

    function startPosition(e) {
        painting = true;
        draw(e);
    }
    function endPosition() {
        painting = false;
        ctx.beginPath();
    }
    function draw(e) {
        if (!painting) return;
        e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ù…

        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        const x = clientX - rect.left;
        const y = clientY - rect.top;

        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.strokeStyle = currentColor;

        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    canvas.addEventListener('mousedown', startPosition);
    canvas.addEventListener('mouseup', endPosition);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchstart', startPosition);
    canvas.addEventListener('touchend', endPosition);
    canvas.addEventListener('touchmove', draw);

    // 5. Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø¯Ù…Ø¬ Ø§Ù„ØµÙˆØ±Ø© + Ø§Ù„Ù†Øµ)
    function saveFeedback() {
        const note = document.getElementById('noteInput').value;
        const timestamp = formatTime(video.currentTime);
        
        // Ø®Ø¯Ø¹Ø©: Ø¯Ù…Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ Ø§Ù„Ø±Ø³Ù…Ø© ÙÙŠ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø©
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = video.videoWidth;
        tempCanvas.height = video.videoHeight;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Ø±Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ÙˆÙ„
        tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
        // Ø±Ø³Ù… Ø§Ù„Ø´Ø®Ø¨Ø·Ø© ÙÙˆÙ‚Ù‡ (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© ÙØ±Ù‚ Ø§Ù„Ø­Ø¬Ù…)
        tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
        
        // ØªØ­ÙˆÙŠÙ„ Ù„Ù€ Base64
        const imageData = tempCanvas.toDataURL('image/jpeg', 0.6); // Ø¬ÙˆØ¯Ø© Ù…ØªÙˆØ³Ø·Ø© Ù„Ù„ØªØ®ÙÙŠÙ

        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        feedbackArray.push({
            time: timestamp,
            rawTime: video.currentTime,
            note: note,
            image: imageData
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        updateFeedbackList();
        cancelEditing(); // Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
    }function cancelEditing() {
        isEditing = false;
        canvas.style.pointerEvents = 'none';
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ù…Ø©
        
        document.getElementById('drawingTools').style.display = 'none';
        document.getElementById('addNoteBtn').style.display = 'flex';
        document.getElementById('noteModal').style.display = 'none';
        document.getElementById('noteInput').value = '';

        // Ø¥Ø²Ø§Ù„Ø© Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¤Ù‚Øª (Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¬ÙˆÙ‡ Ø§Ù„Ø¯Ø§Ù„Ø©)
        const tempBtn = document.getElementById('tempSaveBtn');
        if(tempBtn) tempBtn.remove();
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ´ØºÙŠÙ„
        video.controls = true; 
        video.play();
    }

    function updateFeedbackList() {
        const list = document.getElementById('feedbackList');
        list.innerHTML = '';
        feedbackArray.forEach((item, index) => {
            list.innerHTML += `
                <div class="feedback-item">
                    <img src="${item.image}" class="feedback-thumb" onclick="jumpTo(${item.rawTime})">
                    <div class="feedback-content">
                        <span class="feedback-time">${item.time}</span>
                        <p class="feedback-note">${item.note}</p>
                    </div>
                    <button class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-trash"></i></button>
                </div>
            `;
        });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        const finishBtn = document.getElementById('finishBtn');
        if (feedbackArray.length > 0) {
            finishBtn.style.display = 'flex';
            document.getElementById('count').innerText = feedbackArray.length;
        } else {
            finishBtn.style.display = 'none';
        }
    }

    function deleteItem(index) {
        feedbackArray.splice(index, 1);
        updateFeedbackList();
    }

    function jumpTo(time) {
        video.currentTime = time;
        video.pause();
    }

    // 6. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø³ÙŠØ±ÙØ±
    async function submitAll() {
        const btn = document.getElementById('finishBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        btn.disabled = true;

        const payload = {
            projectId: projectId,
            feedbacks: feedbackArray
        };

        // âš ï¸ Ù‡Ø§Ù…: Ù‡Ù†Ø§ Ø¨Ù†Ø³ØªØ®Ø¯Ù… API Ø®Ø§Ø±Ø¬ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØ± Ø­Ø¬Ù…Ù‡Ø§ ÙƒØ¨ÙŠØ±
        // Ù„Ø§Ø²Ù… Ù†Ø­Ø¯Ø« Ø§Ù„Ø³ÙŠØ±ÙØ± (Nginx & Node) Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ø¯Ù‡
        try {
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯Ù‡ Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨ØªØ§Ø¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            // Ø¨Ù…Ø§ Ø§Ù†Ù†Ø§ Ù„Ø³Ù‡ Ù…Ø¬Ù‡Ø²Ù†Ø§Ø´ Ø§Ù„Ù€ APIØŒ Ø¯ÙŠ Ø®Ø·ÙˆØ© Ø§Ø³ØªØ¨Ø§Ù‚ÙŠØ©
            const response = await fetch('https://files.royamedia.com/api/submit-review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                tg.showPopup({ title: 'ØªÙ…!', message: 'ÙˆØµÙ„Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ ğŸš€', buttons: [{type: "ok"}] });
                tg.close();
            } else {
                throw new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
            }
        } catch (e) {
            // Ø­Ù„ Ø¨Ø¯ÙŠÙ„ Ù…Ø¤Ù‚Øª (Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø³Ù‡ Ù…Ø´ Ø¬Ø§Ù‡Ø²)
            // Ù‡Ù†Ø¨Ø¹Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø© (Ù…Ù…ÙƒÙ† ÙŠÙØ´Ù„ Ù„Ùˆ Ø§Ù„ØµÙˆØ± ÙƒØªÙŠØ±)
            try {
                tg.sendData(JSON.stringify({ 
                    action: "VIDEO_FEEDBACK_V2", 
                    projectId: projectId, 
                    count: feedbackArray.length,
                    // Ø¨Ù†Ø¨Ø¹Øª Ù…Ù„Ø®Øµ Ø¨Ø³ Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø¬Ù…
                    summary: feedbackArray.map(f => `â° ${f.time}: ${f.note}`).join('\n') 
                }));
            } catch (err) {
                alert("âŒ Ø§Ù„ØµÙˆØ± ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ù„Ø§Ø²Ù… Ù†Ø­Ø¯Ø« Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø£ÙˆÙ„!");
            }
        }
        btn.disabled = false;
        btn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
    }

    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    function setColor(color, btn) {
        currentColor = color;
        document.querySelectorAll('.color-btn').forEach(b => b.style.transform = 'scale(1)');
        btn.style.transform = 'scale(1.2)';
    }
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }
</script>
</body>
</html>
